# AI-Powered Fundamental Analyst Agent

An intelligent investment analysis system that combines traditional fundamental analysis (DCF & multiples valuation) with AI-powered narrative generation to produce professional equity research reports.

## Table of Contents
- [Overview](#overview)
- [Features](#features)
- [Installation](#installation)
- [Usage](#usage)
- [Project Structure](#project-structure)
- [Configuration](#configuration)
- [Methodology](#methodology)
- [Example Output](#example-output)
- [API Rate Limits](#api-rate-limits)
- [Troubleshooting](#troubleshooting)
- [Limitations & Assumptions](#limitations--assumptions)
- [Contributing](#contributing)
- [License](#license)
- [Disclaimer](#disclaimer)

## Overview

This agent automates the complete workflow of equity research analysis, from data collection to report generation. It leverages multiple data sources, implements industry-standard valuation methodologies, and uses large language models (Claude Sonnet 4 / GPT-4) to generate professional-grade investment narratives.

**Key Differentiators:**
- **Dual Methodology**: Combines intrinsic value (DCF) with relative value (multiples)
- **AI-Enhanced Analysis**: Qualitative insights generated by state-of-the-art LLMs
- **Production-Ready Infrastructure**: Robust error handling, multi-source fallbacks, and intelligent caching
- **Professional Output**: Client-ready PDF reports with comprehensive analysis
- **Cost-Efficient Design**: 72-hour caching minimizes API costs and rate limit issues
- **Modular Architecture**: Easy to extend with new valuation methods or data sources

## Features

### Core Analysis Capabilities

#### 1. Discounted Cash Flow (DCF) Valuation
The DCF module implements a rigorous unlevered free cash flow approach:

- **Free Cash Flow to Firm (FCFF)** methodology with complete formula implementation
  ```
  FCFF = EBIT × (1 - Tax Rate) + Depreciation & Amortization - CapEx - ΔNWC
  ```
- **Automatic CAGR calculation** from up to 5 years of historical data
- **Terminal growth sensitivity analysis** across multiple scenarios (3%, 4%, 5%)
- **WACC calculation** using CAPM with real-time market inputs
- **Multi-source data fetching** for risk-free rate (FRED, Alpha Vantage, Treasury.gov, MarketWatch, yfinance)
- **Intelligent beta estimation** with fallback mechanisms
- **Net debt adjustment** for accurate equity value calculation
- **Configurable parameters**: forecast years, terminal growth, growth caps, equity risk premium

#### 2. Multiples Valuation (Relative Valuation)
Comprehensive peer-based valuation using multiple metrics:

- **Price-to-Earnings (P/E)**: Earnings power comparison
- **Price-to-Book (P/B)**: Asset-based valuation for balance-sheet intensive companies
- **Price-to-Sales (P/S)**: Revenue multiple analysis for growth companies
- **EV/EBITDA**: Enterprise value to operating performance ratio
- **Peer company analysis** with customizable peer selection (default: MSFT, GOOGL, META, NVDA for tech stocks)
- **Median-based valuation** to reduce outlier impact
- **Outlier filtering**: Automatically excludes implied prices deviating >50% from current price
- **Weighted averaging** across all valid multiples for final target

#### 3. Blended Recommendation Engine
Sophisticated decision logic combining both methodologies:

- **60% DCF / 40% Multiples weighting** for balanced intrinsic + relative value approach
- **BUY/HOLD/SELL recommendations** with confidence levels (High/Medium)
- **Threshold-based decision logic**:
  - **BUY**: Upside > 20% (High confidence if > 30%)
  - **HOLD**: -15% to 20% upside (Medium confidence)
  - **SELL**: Upside < -15% (High confidence if < -25%)
- **Sensitivity analysis** showing valuation ranges under different terminal growth assumptions

#### 4. Financial Ratio Analysis
Supporting metrics for comprehensive evaluation:

- **Profitability**: Net Margin, Return on Equity (ROE)
- **Leverage**: Debt-to-Equity Ratio
- **Growth**: Revenue Growth %, Net Income Growth %
- **Cash Flow**: Free Cash Flow trends, FCF CAGR
- **Valuation**: Current multiples vs. historical and peer benchmarks

### AI Integration

#### Large Language Model Analysis
Professional narrative generation using state-of-the-art LLMs:

- **Primary Model**: Anthropic Claude Sonnet 4 (latest model)
- **Fallback Model**: OpenAI GPT-4 (automatic failover)
- **Context-aware generation** using all quantitative results as input
- **Structured output** with consistent sections:
  - **Executive Summary**: One-paragraph overview with clear BUY/HOLD/SELL recommendation
  - **Valuation Analysis**: Discussion of DCF and multiples approaches with key insights
  - **Key Risks**: Identification of potential downside scenarios and concerns
  - **Investment Thesis**: Core argument for or against investing
  - **Price Target**: Recommended target with data-driven reasoning

### Report Generation

#### JSON Export (Machine-Readable)
Comprehensive structured data format ideal for:
- Integration with trading systems, dashboards, or databases
- Programmatic analysis and backtesting frameworks
- Historical data tracking and trend analysis
- API consumption by downstream applications

**JSON Structure Includes:**
- All DCF metrics (FCFF, WACC, enterprise value, equity value, shares)
- Complete multiples analysis (current, peer median, implied prices by metric)
- Sensitivity analysis results across terminal growth scenarios
- Recommendation and confidence levels
- Full AI-generated report text
- Timestamp and metadata for tracking

#### PDF Reports (Human-Readable)
Professional, client-ready investment reports featuring:

- **Title Page**: Ticker symbol, report date, and metadata
- **Executive Summary**: Color-coded recommendation (green BUY, yellow HOLD, red SELL)
- **DCF Analysis Section**: Detailed metrics table with WACC breakdown
- **Terminal Growth Sensitivity**: Table showing price targets under 3%, 4%, 5% growth
- **Multiples Comparison**: Current vs. peer median with implied prices
- **AI-Generated Narrative**: Professional investment analysis with markdown formatting
- **Professional Styling**: Custom fonts, colors, tables, and multi-page layouts
- **Automatic Pagination**: Intelligent page breaks and spacing

### Data Management & Infrastructure

#### Multi-Source Data Collection

**Alpha Vantage API Integration:**
- 5 years of annual financial statements (income, balance sheet, cash flow)
- Company overview data (beta, shares outstanding, key ratios)
- Field name standardization (Alpha Vantage → yfinance format)
- Rate limit compliance (12-second delays between requests)

**Market Data Sources:**
- Current stock price, beta, shares outstanding
- Risk-free rate from multiple sources with fallbacks
- Peer company multiples for industry comparison

#### Intelligent Caching System (72-Hour TTL)

Minimizes API costs and avoids rate limiting:

**Cache Types:**
1. **Financial Statements Cache**: Permanent storage until manually refreshed
2. **Market Data Cache**: Price, beta, shares (72h expiry, auto-refresh)
3. **Risk-Free Rate Cache**: 10-year Treasury yield (72h expiry)
4. **Peer Multiples Cache**: Industry comparables (72h expiry)
5. **Current Multiples Cache**: Target stock ratios (72h expiry)

**Cache Benefits:**
- Reduces API calls by ~80% for repeated analyses
- Ensures consistent data within 72-hour window
- Automatic timestamp validation and refresh
- CSV-based for easy inspection and debugging

#### Robust Fallback Mechanisms

Ensures reliability when primary sources fail:

**Risk-Free Rate Sources (in order):**
1. FRED (Federal Reserve Economic Data) - Most reliable
2. Alpha Vantage TREASURY_YIELD endpoint
3. Treasury.gov official website
4. MarketWatch financial data
5. yfinance (^TNX ticker)

**Market Data Sources:**
1. Alpha Vantage (primary, with API key)
2. yfinance (fallback, free but rate-limited)

**AI Model Fallback:**
1. Claude Sonnet 4 (Anthropic)
2. GPT-4 (OpenAI) - activates if Claude fails

**Cost of Debt Calculation:**
1. Direct calculation (Interest Expense / Avg Debt)
2. Market-based estimate using D/E ratio and credit spreads
3. Conservative estimate (Rf + 100bps)

---

##  Installation

### Prerequisites
- Python 3.9+
- Alpha Vantage API key (free tier: https://www.alphavantage.co/support/#api-key)
- Anthropic API key (https://console.anthropic.com/)

### Setup

1. **Clone the repository**
```bash
git clone https://github.com/yourusername/fundamental-analyst-agent.git
cd fundamental-analyst-agent
```

2. **Create virtual environment**
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. **Install dependencies**
```bash
pip install -r requirements.txt
```

4. **Configure environment variables**
```bash
cp .env.example .env
```

Edit `.env` and add your API keys:
```
ANTHROPIC_API_KEY=your_anthropic_api_key_here
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_api_key_here
```

---

## Usage

### Quick Start (Full Analysis)

For a complete end-to-end analysis with a single command:

```bash
python src/ai_agent.py TSLA
```

This command automatically:
1. Collects financial data from Alpha Vantage (if not cached)
2. Performs DCF and multiples valuation
3. Generates AI-powered investment insights
4. Creates JSON output with all results

**Output Location:** `shared_outputs/fundamental_mohamed_TSLA.json`

**First Run Note:** May take ~40 seconds due to API rate limits during initial data collection.

---

### Step-by-Step Usage (Manual Control)

For more granular control over the analysis process:

#### Step 1: Collect Financial Data

Fetch historical financial statements from Alpha Vantage:

```bash
cd src
python Data_collector.py AAPL
```

**What This Does:**
- Downloads 5 years of annual financial statements from Alpha Vantage
- Retrieves: income statements, balance sheets, cash flow statements
- Transforms Alpha Vantage JSON format to yfinance-compatible CSV format
- Saves to `data/raw/AAPL/` directory
- Creates metadata file with download timestamp

**Files Created:**
```
data/raw/AAPL/
├── income_statement.csv    # Revenue, expenses, net income
├── balance_sheet.csv        # Assets, liabilities, equity
├── cash_flow.csv           # Operating, investing, financing cash flows
└── metadata.csv            # Download timestamp and source info
```

**Time Required:** ~30 seconds (3 API calls × 12 second delays for rate limiting)

**Caching Behavior:**
- Data is cached permanently until manually deleted
- No need to re-run unless you want refreshed financial data
- Use `rm -rf data/raw/AAPL` to clear cache for a specific ticker

**Rate Limit Note:** Alpha Vantage free tier allows 5 calls/minute, 25 calls/day

---

#### Step 2: Run Fundamental Analysis

Execute comprehensive valuation analysis:

```bash
python src/fundamental_analyzer.py
```

**What This Does:**
1. Loads cached financial statements from CSV files
2. Fetches current market data (price, beta, shares outstanding)
3. Fetches risk-free rate from multiple sources
4. Calculates:
   - Free Cash Flow to Firm (FCFF) for past 5 years
   - WACC using CAPM methodology
   - DCF intrinsic value with terminal value
   - Profitability, leverage, and growth ratios
5. Fetches peer company multiples (MSFT, GOOGL, META, NVDA)
6. Calculates implied prices using P/E, P/B, P/S, EV/EBITDA
7. Generates blended recommendation (60% DCF, 40% Multiples)
8. Runs terminal growth sensitivity analysis

**Terminal Output Example:**
```
======================================================================
FETCHING 10-YEAR US TREASURY RATE
======================================================================
  ✓ FRED: 0.0445 (4.45%) as of 2024-01-15

✓ Successfully fetched from FRED: 4.45%
======================================================================

======================================================================
FETCHING MARKET DATA
======================================================================
  ✓ Price from Alpha Vantage: $255.53
  ✓ Beta from Alpha Vantage: 1.23
  ✓ Shares from Alpha Vantage: 15,204,100,000
✓ Alpha Vantage fetch successful
======================================================================

======================================================================
DCF VALUATION
======================================================================

Forecast Growth (CAGR):        8.92%
WACC:                          10.10%
DCF Intrinsic Price:           $145.23
Current Price:                 $255.53
DCF Upside:                    -43.16%

======================================================================
MULTIPLES VALUATION
======================================================================

Current Multiples (AAPL):
  P/E: 33.11
  P/B: 50.94
  P/S: 8.76
  EV/EBITDA: 26.25

Peer Median Multiples:
  P/E: 31.45
  P/B: 8.12
  P/S: 7.23
  EV/EBITDA: 22.34

Implied Prices by Multiple:
  P/E: $248.67
  P/B: $49.41
  P/S: $311.46
  EV/EBITDA: $205.12

Multiples Average Price:       $203.66
Multiples Upside:              -20.31%

======================================================================
BLENDED RECOMMENDATION (60% DCF / 40% Multiples)
======================================================================

DCF Target (60%):              $145.23
Multiples Target (40%):        $203.66
Blended Target Price:          $168.60
Current Price:                 $255.53
Blended Upside:                -34.03%

======================================================================
FINAL RECOMMENDATION: SELL (High Confidence)
======================================================================

======================================================================
TERMINAL GROWTH SENSITIVITY (3%, 4%, 5%)
======================================================================

Terminal Growth    Target Price        Upside
--------------------------------------------------
              3.0%  $      132.45       -48.18%
              4.0%  $      145.23       -43.16%
              5.0%  $      161.89       -36.65%
```

**Caching Behavior:**
- Market data cached for 72 hours
- Automatically refreshes if cache expired
- Shows cache age in output (e.g., "age: 2d 5h")

---

#### Step 3: Generate AI-Powered Report

Create comprehensive analysis with AI insights:

```bash
python src/ai_agent.py AAPL
```

**What This Does:**
1. Runs Step 1 (data collection) if needed
2. Runs Step 2 (fundamental analysis)
3. Calls Large Language Model (Claude Sonnet 4 or GPT-4) with quantitative results
4. Generates professional investment narrative
5. Creates structured JSON output

**AI Prompt Structure:**
The system provides the LLM with:
- All DCF metrics (intrinsic price, WACC, growth rates, enterprise value)
- All multiples metrics (current ratios, peer medians, implied prices)
- Blended recommendation and upside percentage

The LLM generates:
1. **Executive Summary**: One-paragraph overview with clear recommendation
2. **Valuation Analysis**: Discussion of both DCF and multiples methodologies
3. **Key Risks**: Potential factors that could invalidate the thesis
4. **Investment Thesis**: Core argument for or against investing
5. **Price Target**: Recommended target with supporting rationale

**Generated Files:**
- `shared_outputs/fundamental_mohamed_AAPL.json` - Complete structured output

**JSON Structure:**
```json
{
  "ticker": "AAPL",
  "report_date": "2024-01-15T14:30:00",
  "current_price": 255.53,
  "recommendation": "SELL",
  "confidence": "High",
  "blended_target": 168.60,
  "upside_potential": -34.03,
  "dcf_target": 145.23,
  "multiples_target": 203.66,
  "dcf_valuation": {
    "intrinsic_price": 145.23,
    "forecast_growth": 0.0892,
    "wacc": 0.1010,
    "terminal_growth": 0.04,
    "fcff_base": 85234000000,
    "enterprise_value": 2345678900000,
    "net_debt": -89123400000,
    "equity_value": 2434802300000,
    "shares_outstanding": 15204100000
  },
  "multiples_valuation": {
    "current_multiples": {
      "P/E": 33.11,
      "P/B": 50.94,
      "P/S": 8.76,
      "EV/EBITDA": 26.25
    },
    "peer_median_multiples": {
      "P/E": 31.45,
      "P/B": 8.12,
      "P/S": 7.23,
      "EV/EBITDA": 22.34
    },
    "implied_prices": {
      "P/E": 248.67,
      "P/B": 49.41,
      "P/S": 311.46,
      "EV/EBITDA": 205.12
    },
    "average_implied_price": 203.66
  },
  "sensitivity": [
    {
      "terminal_growth": 0.03,
      "wacc": 0.1010,
      "intrinsic_price": 132.45,
      "current_price": 255.53
    },
    {
      "terminal_growth": 0.04,
      "wacc": 0.1010,
      "intrinsic_price": 145.23,
      "current_price": 255.53
    },
    {
      "terminal_growth": 0.05,
      "wacc": 0.1010,
      "intrinsic_price": 161.89,
      "current_price": 255.53
    }
  ],
  "ai_report": "**Executive Summary**\n\nBased on comprehensive DCF and multiples analysis..."
}
```

**API Costs:**
- Claude Sonnet 4: ~$0.01-0.03 per report (depending on length)
- GPT-4: ~$0.03-0.05 per report (fallback only)

---

### Advanced Usage Examples

#### Analyze Multiple Stocks in Batch

Create a bash script to analyze multiple tickers:

```bash
#!/bin/bash
# batch_analyze.sh

tickers=("AAPL" "MSFT" "GOOGL" "TSLA" "NVDA" "META")

for ticker in "${tickers[@]}"; do
  echo "================================"
  echo "Analyzing $ticker..."
  echo "================================"
  python src/ai_agent.py "$ticker"

  # Pause between analyses to respect rate limits
  sleep 15

  echo "✓ $ticker complete"
  echo ""
done

echo "All analyses complete!"
```

Run with:
```bash
chmod +x batch_analyze.sh
./batch_analyze.sh
```

#### Custom Valuation Parameters

Programmatically adjust assumptions:

```python
from src.fundamental_analyzer import FundamentalAnalyzer

# Initialize analyzer
analyzer = FundamentalAnalyzer("AAPL", data_path="data/raw/AAPL")

# Ensure market data cache exists
if not analyzer.market_data_cache:
    analyzer.update_market_data_cache()

# Run DCF with custom parameters
dcf_conservative = analyzer.dcf_valuation(
    forecast_years=7,           # Longer projection period
    terminal_growth=0.025,      # Lower long-term growth (2.5%)
    cap_forecast_growth=0.12,   # More conservative growth cap (12%)
    default_erp=0.07,           # Higher equity risk premium (7%)
)

dcf_aggressive = analyzer.dcf_valuation(
    forecast_years=5,
    terminal_growth=0.05,       # Higher terminal growth (5%)
    cap_forecast_growth=0.25,   # Allow higher near-term growth (25%)
    default_erp=0.045,          # Lower ERP (4.5%)
)

print(f"Conservative Target: ${dcf_conservative['intrinsic_price']:.2f}")
print(f"Aggressive Target: ${dcf_aggressive['intrinsic_price']:.2f}")

# Custom peer group
multiples_tech = analyzer.multiples_valuation(
    peers=["MSFT", "GOOGL", "META", "NVDA"]  # Pure tech
)

multiples_faang = analyzer.multiples_valuation(
    peers=["MSFT", "GOOGL", "META", "AMZN", "NFLX"]  # FAANG comparison
)

print(f"Tech Peers Target: ${multiples_tech['average_implied_price']:.2f}")
print(f"FAANG Peers Target: ${multiples_faang['average_implied_price']:.2f}")
```

#### Access Individual Metrics

Use specific components for custom analysis:

```python
from src.fundamental_analyzer import FundamentalAnalyzer

analyzer = FundamentalAnalyzer("AAPL", data_path="data/raw/AAPL")

# Get profitability metrics
profitability = analyzer.profitability_ratios()
print("\nProfitability Ratios:")
print(profitability)

# Output:
#          2019      2020      2021      2022      2023
# Net Margin  0.212  0.209  0.259  0.253  0.247
# ROE         0.556  0.738  1.501  1.968  1.722

# Get growth metrics
growth = analyzer.growth_rates()
print("\nGrowth Rates:")
print(growth)

# Get leverage metrics
leverage = analyzer.leverage_ratios()
print("\nLeverage:")
print(leverage)

# Get WACC components
wacc = analyzer.wacc()
re = analyzer.cost_of_equity_capm()
rd = analyzer.cost_of_debt()

print(f"\nCost of Equity (Re): {re:.2%}")
print(f"Cost of Debt (Rd): {rd:.2%}")
print(f"WACC: {wacc:.2%}")

# Get cash flow metrics
fcf = analyzer.free_cash_flow_fcff()
print("\nFree Cash Flow (FCFF):")
print(fcf)
```

#### Programmatic JSON Processing

Analyze results programmatically:

```python
import json
from pathlib import Path

# Load analysis result
json_path = Path("shared_outputs/fundamental_mohamed_AAPL.json")
with open(json_path, 'r') as f:
    data = json.load(f)

# Extract key metrics
recommendation = data['recommendation']
confidence = data['confidence']
upside = data['upside_potential']
dcf_price = data['dcf_target']
multiples_price = data['multiples_target']

# Custom decision logic
if recommendation == "BUY" and confidence == "High" and upside > 25:
    print(f"STRONG BUY: {upside:.1f}% upside")
    print(f"Action: Consider 5% portfolio allocation")
elif recommendation == "SELL" and confidence == "High":
    print(f"STRONG SELL: {upside:.1f}% downside")
    print(f"Action: Exit position if held")
else:
    print(f"{recommendation}: {upside:.1f}% potential")
    print(f"Action: Monitor, no immediate action")

# Analyze valuation spread
spread = abs(dcf_price - multiples_price) / min(dcf_price, multiples_price)
if spread > 0.30:
    print(f"\nWARNING: Large valuation spread ({spread:.1%})")
    print("DCF and Multiples disagree significantly")
```

---

##  Project Structure

```
fundamental-analyst-agent/
├── src/
│   ├── Data_collector.py          # Fetch financial data from Alpha Vantage
│   ├── fundamental_analyzer.py     # Core valuation engine (DCF + multiples)
│   ├── ai_agent.py                 # AI narrative generation with Claude
│   └── report_generator.py         # JSON/PDF report generation
├── data/
│   ├── raw/                        # Financial statements (CSV)
│   └── cache/                      # API response cache
├── reports/                        # Generated JSON/PDF reports
├── .env                            # API keys (not in git)
├── .env.example                    # Template for environment variables
├── requirements.txt                # Python dependencies
└── README.md                       # This file
```

---

## Configuration

### Environment Variables

Create a `.env` file in the project root with your API keys:

```bash
# Alpha Vantage API (Required for data collection)
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key_here
ALPHA_VANTAGE_API_KEY_MOHAMED=your_alpha_vantage_key_here  # Alternative key name

# AI Model APIs (Required for AI-powered reports)
ANTHROPIC_API_KEY=your_anthropic_key_here  # Primary (Claude Sonnet 4)
OPENAI_API_KEY=your_openai_key_here        # Fallback (GPT-4)
```

**Getting API Keys:**
- **Alpha Vantage**: Free tier available at https://www.alphavantage.co/support/#api-key
  - Limits: 5 calls/minute, 25 calls/day
  - No credit card required
- **Anthropic**: Sign up at https://console.anthropic.com/
  - Pay-per-use pricing (~$0.01-0.03 per analysis)
  - Requires payment method
- **OpenAI**: Sign up at https://platform.openai.com/
  - Only needed as fallback if Anthropic fails
  - Pay-per-use pricing (~$0.03-0.05 per analysis)

---

### Valuation Parameters

#### DCF Configuration

Adjust DCF assumptions in `fundamental_analyzer.py` or via function parameters:

```python
dcf_result = analyzer.dcf_valuation(
    forecast_years=5,           # Projection period (default: 5)
                                # Higher = more assumptions, Lower = more conservative

    terminal_growth=0.04,       # Perpetual growth rate (default: 4%)
                                # Typical range: 2%-5% (≈ GDP growth)
                                # Must be < WACC

    cap_forecast_growth=0.20,   # Maximum CAGR cap (default: 20%)
                                # Prevents unrealistic projections from outlier years
                                # Set lower (e.g., 0.12) for mature companies

    default_erp=0.055,          # Equity Risk Premium (default: 5.5%)
                                # Historical average: 4.5%-6%
                                # Higher = higher discount rate = lower valuation
)
```

**Parameter Guidelines by Company Type:**

| Company Type | forecast_years | terminal_growth | cap_forecast_growth | default_erp |
|--------------|----------------|-----------------|---------------------|-------------|
| **Mature (e.g., Coca-Cola)** | 5 | 0.025-0.03 | 0.08-0.12 | 0.05-0.055 |
| **Growth (e.g., Tesla)** | 7-10 | 0.03-0.045 | 0.20-0.30 | 0.06-0.07 |
| **Stable Tech (e.g., Microsoft)** | 5-7 | 0.03-0.04 | 0.12-0.18 | 0.055-0.06 |
| **Cyclical (e.g., Ford)** | 5 | 0.025-0.035 | 0.10-0.15 | 0.055-0.065 |

---

#### Multiples Configuration

Customize peer selection based on industry:

```python
# Technology companies
multiples = analyzer.multiples_valuation(
    peers=["MSFT", "GOOGL", "META", "NVDA", "AMZN"]
)

# Financial services
multiples = analyzer.multiples_valuation(
    peers=["JPM", "BAC", "WFC", "C", "GS"]
)

# Consumer discretionary
multiples = analyzer.multiples_valuation(
    peers=["AMZN", "HD", "NKE", "MCD", "SBUX"]
)

# Healthcare
multiples = analyzer.multiples_valuation(
    peers=["JNJ", "UNH", "PFE", "ABBV", "TMO"]
)

# Energy
multiples = analyzer.multiples_valuation(
    peers=["XOM", "CVX", "COP", "SLB", "EOG"]
)
```

**Peer Selection Best Practices:**
1. Choose 4-6 peers (enough for median calculation, not too many outliers)
2. Select companies in same industry/sector
3. Prefer similar business models and market cap
4. Avoid companies in distress or with unusual circumstances
5. Update peer list periodically as industries evolve

---

#### Recommendation Thresholds

Modify buy/sell decision thresholds in `report_generator.py`:

```python
# Default thresholds
if blended_upside > 20:
    recommendation = "BUY"
    confidence = "High" if blended_upside > 30 else "Medium"
elif blended_upside < -15:
    recommendation = "SELL"
    confidence = "High" if blended_upside < -25 else "Medium"
else:
    recommendation = "HOLD"
    confidence = "Medium"
```

**Custom Threshold Examples:**

**Conservative (Higher conviction required):**
```python
if blended_upside > 30:        # BUY only if >30% upside
    recommendation = "BUY"
elif blended_upside < -20:     # SELL only if >20% downside
    recommendation = "SELL"
else:
    recommendation = "HOLD"
```

**Aggressive (Lower conviction threshold):**
```python
if blended_upside > 10:        # BUY at >10% upside
    recommendation = "BUY"
elif blended_upside < -10:     # SELL at >10% downside
    recommendation = "SELL"
else:
    recommendation = "HOLD"
```

**Three-Tier System:**
```python
if blended_upside > 40:
    recommendation = "STRONG BUY"
elif blended_upside > 15:
    recommendation = "BUY"
elif blended_upside < -30:
    recommendation = "STRONG SELL"
elif blended_upside < -15:
    recommendation = "SELL"
else:
    recommendation = "HOLD"
```

---

#### Blended Weighting

Adjust the DCF/Multiples blend in `ai_agent.py`:

```python
# Default: 60% DCF, 40% Multiples
blended_price = dcf_result['intrinsic_price'] * 0.6 + multiples['average_implied_price'] * 0.4

# More intrinsic value focused (70% DCF, 30% Multiples)
blended_price = dcf_result['intrinsic_price'] * 0.7 + multiples['average_implied_price'] * 0.3

# Equal weighting (50% DCF, 50% Multiples)
blended_price = dcf_result['intrinsic_price'] * 0.5 + multiples['average_implied_price'] * 0.5

# More market-driven (40% DCF, 60% Multiples)
blended_price = dcf_result['intrinsic_price'] * 0.4 + multiples['average_implied_price'] * 0.6
```

**Weighting Guidelines:**
- **More DCF weight**: When you trust cash flow projections, for mature companies
- **More Multiples weight**: When comparable companies are truly similar, for sectors with standard multiples
- **Equal weight**: When uncertain about which method is more reliable

---

### Cache Configuration

#### Adjust Cache Expiry

Modify cache expiration in `fundamental_analyzer.py`:

```python
# Default: 72 hours
CACHE_EXPIRY_HOURS = 72

# Shorter expiry for more frequent updates (24 hours)
CACHE_EXPIRY_HOURS = 24

# Longer expiry to minimize API calls (7 days)
CACHE_EXPIRY_HOURS = 168
```

#### Clear Cache Manually

```bash
# Clear all cache
rm -rf data/cache/*.csv

# Clear specific cache types
rm data/cache/market_data_cache.csv
rm data/cache/peer_multiples_cache.csv
rm data/cache/current_multiples_cache.csv

# Clear financial data for specific ticker
rm -rf data/raw/AAPL

# Clear all financial data
rm -rf data/raw/*
```

---

### AI Model Configuration

#### Switch Primary AI Model

In `ai_agent.py`, the model hierarchy is:

```python
# Try Anthropic first
client = Anthropic(api_key=self.anthropic_key)
message = client.messages.create(
    model="claude-sonnet-4-20250514",  # Latest Claude model
    max_tokens=2000,
    messages=[{"role": "user", "content": prompt}]
)

# Fallback to OpenAI
client = OpenAI(api_key=self.openai_key)
completion = client.chat.completions.create(
    model="gpt-4o",  # GPT-4 Optimized
    max_tokens=2000,
    messages=[{"role": "user", "content": prompt}]
)
```

**Available Models:**
- **Claude**: `claude-sonnet-4-20250514`, `claude-opus-4-20241113`
- **OpenAI**: `gpt-4o`, `gpt-4-turbo`, `gpt-4`

#### Adjust AI Output Length

```python
# Shorter reports (default: 2000)
max_tokens=1000

# Longer, more detailed reports
max_tokens=3000
```

**Token Guidelines:**
- 1000 tokens ≈ 750 words (brief summary)
- 2000 tokens ≈ 1500 words (standard report)
- 3000 tokens ≈ 2250 words (comprehensive analysis)

---

### Output Configuration

#### Change Output Directory

In `ai_agent.py`:

```python
# Default: shared_outputs
SHARED_OUTPUTS = REPO_ROOT / "shared_outputs"

# Custom directory
SHARED_OUTPUTS = Path("/Users/yourname/Desktop/analyses")
SHARED_OUTPUTS.mkdir(exist_ok=True)
```

#### Customize Output Filename

```python
# Default format: fundamental_mohamed_{TICKER}.json
output_path = SHARED_OUTPUTS / f"fundamental_mohamed_{ticker}.json"

# Include timestamp
output_path = SHARED_OUTPUTS / f"analysis_{ticker}_{datetime.now():%Y%m%d_%H%M%S}.json"

# Organize by date folders
date_folder = SHARED_OUTPUTS / f"{datetime.now():%Y-%m-%d}"
date_folder.mkdir(exist_ok=True)
output_path = date_folder / f"{ticker}.json"
```

---

## Methodology

This section provides an in-depth explanation of the valuation methodologies implemented by the agent.

---

### 1. Discounted Cash Flow (DCF) Valuation

The DCF model values a company based on the present value of its future cash flows. This agent uses the **Free Cash Flow to the Firm (FCFF)** approach, which represents cash available to all capital providers (both equity and debt holders).

#### Step 1: Calculate Historical Free Cash Flow

**Formula:**
```
FCFF = EBIT × (1 - Tax Rate) + D&A - CapEx - ΔNWC
```

**Component Breakdown:**

**EBIT (Earnings Before Interest and Tax):**
- Also called Operating Income
- Retrieved from income statement
- Represents profit from core operations before financing costs

**Tax Rate (Effective):**
```
Tax Rate = Tax Provision / Pretax Income
```
- Uses most recent year's data
- Capped at 50% to handle anomalies
- Floored at 0% to handle tax credits

**D&A (Depreciation & Amortization):**
- Non-cash expense that reduces net income
- Added back because it doesn't represent actual cash outflow
- Retrieved from cash flow statement

**CapEx (Capital Expenditures):**
- Cash spent on property, plant, equipment (PP&E)
- Represents investment in long-term assets
- Negative value in cash flow statement (cash outflow)
- Subtracted from FCFF as it's cash we can't distribute

**ΔNWC (Change in Net Working Capital):**
```
NWC = (Current Assets - Cash) - (Current Liabilities - Short-term Debt)
ΔNWC = NWC_current_year - NWC_previous_year
```

**Why exclude Cash and Short-term Debt from NWC?**
- Cash is non-operating (already captured in final equity value)
- Short-term debt is financing (not operations)

**Example Calculation:**
```
Company XYZ (2023):
EBIT: $100M
Tax Rate: 21%
D&A: $15M
CapEx: -$20M
ΔNWC: -$5M (working capital decreased = cash inflow)

FCFF = $100M × (1 - 0.21) + $15M - $20M - (-$5M)
     = $79M + $15M - $20M + $5M
     = $79M
```

---

#### Step 2: Estimate Growth Rate

**Compound Annual Growth Rate (CAGR) Calculation:**
```
CAGR = (FCFF_end / FCFF_start)^(1/years) - 1
```

**Implementation:**
- Uses **2-year CAGR** by default (most recent trend)
- Requires minimum 3 years of historical data
- **Growth cap**: 20% maximum to avoid unrealistic projections
- **Negative growth allowed**: Minimum -50%

**Why 2-year CAGR?**
- More recent data = more relevant for near-term forecasts
- Balances between recency and smoothing out volatility
- 5-year CAGR can be influenced by stale trends

**Handling Edge Cases:**
- If FCFF_start ≤ 0: CAGR not meaningful (error thrown)
- If historical FCFF volatile: Consider median or mode growth

**Example:**
```
Historical FCFF:
2021: $50M
2022: $60M
2023: $75M

2-year CAGR = ($75M / $50M)^(1/2) - 1
            = (1.5)^0.5 - 1
            = 1.2247 - 1
            = 22.47%

Capped at 20% → Final growth rate = 20%
```

---

#### Step 3: Calculate Weighted Average Cost of Capital (WACC)

WACC represents the blended cost of capital from all sources:

**Formula:**
```
WACC = (E/(D+E)) × Re + (D/(D+E)) × Rd × (1-T)
```

**Where:**
- **E**: Market value of equity = Current Price × Shares Outstanding
- **D**: Total debt (long-term + short-term debt)
- **Re**: Cost of equity (return required by equity investors)
- **Rd**: Cost of debt (interest rate on debt)
- **T**: Effective tax rate

---

**3a. Cost of Equity (Re) - CAPM Model:**

```
Re = Rf + β × ERP
```

**Rf (Risk-Free Rate):**
- 10-year US Treasury yield (current, not historical)
- Fetched from multiple sources with fallback hierarchy:
  1. FRED (Federal Reserve Economic Data) - Most reliable
  2. Alpha Vantage TREASURY_YIELD endpoint
  3. Treasury.gov official website
  4. MarketWatch
  5. yfinance (^TNX ticker)
- Typical range: 3%-5% (as of 2024)

**β (Beta):**
- Measures stock's volatility relative to market (S&P 500)
- β = 1.0: Moves with market
- β > 1.0: More volatile than market (higher risk)
- β < 1.0: Less volatile than market (lower risk)
- Fetched from Alpha Vantage or yfinance
- Default: 1.0 if unavailable

**ERP (Equity Risk Premium):**
- Expected return of market above risk-free rate
- Historical average: 5.0%-6.0%
- Default: 5.5%
- Configurable parameter

**Example:**
```
Rf = 4.5% (10-year Treasury)
β = 1.2 (more volatile than market)
ERP = 5.5%

Re = 4.5% + 1.2 × 5.5%
   = 4.5% + 6.6%
   = 11.1%
```

---

**3b. Cost of Debt (Rd):**

The agent uses three approaches with fallbacks:

**Approach 1: Direct Calculation (Most Accurate)**
```
Rd = Interest Expense / Average Total Debt

Where:
Average Debt = (Debt_current + Debt_previous) / 2
```

**Approach 2: Market-Based Estimate (When Interest Expense unavailable)**

Uses Debt-to-Equity ratio to estimate credit rating and spread:

| D/E Ratio | Implied Rating | Credit Spread | Formula |
|-----------|----------------|---------------|---------|
| < 0.3 | AAA/AA | 80 bps | Rd = Rf + 0.008 |
| 0.3-0.5 | A | 120 bps | Rd = Rf + 0.012 |
| 0.5-1.0 | BBB | 180 bps | Rd = Rf + 0.018 |
| ≥ 1.0 | BB or lower | 250 bps | Rd = Rf + 0.025 |

**Approach 3: Conservative Estimate (Fallback)**
```
Rd = Rf + 1.00%
```
- Assumes investment-grade credit quality
- Used when both Approach 1 and 2 fail

**Why Tax Shield?**
```
After-tax cost = Rd × (1-T)
```
Interest is tax-deductible, so actual cost is reduced by tax savings.

**Example:**
```
Interest Expense = $10M
Total Debt (current) = $200M
Total Debt (previous) = $180M
Average Debt = ($200M + $180M) / 2 = $190M

Rd = $10M / $190M = 5.26%

After-tax (T=21%):
Rd_after_tax = 5.26% × (1 - 0.21) = 4.16%
```

---

**3c. Capital Structure Weights:**

```
Equity Weight = E / (E + D)
Debt Weight = D / (E + D)
```

**Example WACC Calculation:**
```
Market Cap (E) = $100B
Total Debt (D) = $30B
Total Capital = $130B

Re = 11.1%
Rd = 5.26%
T = 21%

WACC = ($100B/$130B) × 11.1% + ($30B/$130B) × 5.26% × (1-0.21)
     = 0.769 × 11.1% + 0.231 × 5.26% × 0.79
     = 8.54% + 0.96%
     = 9.50%
```

---

#### Step 4: Project Future Cash Flows

For each year in the forecast period:

```
FCFF_t = FCFF_0 × (1 + g)^t
PV(FCFF_t) = FCFF_t / (1 + WACC)^t
```

**Example (5-year forecast):**
```
FCFF_0 = $79M (base year)
Growth (g) = 15%
WACC = 9.5%

Year 1: FCFF = $79M × 1.15 = $90.85M
        PV = $90.85M / 1.095^1 = $82.97M

Year 2: FCFF = $79M × 1.15^2 = $104.48M
        PV = $104.48M / 1.095^2 = $87.18M

Year 3: FCFF = $79M × 1.15^3 = $120.15M
        PV = $120.15M / 1.095^3 = $91.49M

Year 4: FCFF = $79M × 1.15^4 = $138.17M
        PV = $138.17M / 1.095^4 = $95.90M

Year 5: FCFF = $79M × 1.15^5 = $158.90M
        PV = $158.90M / 1.095^5 = $100.41M

Sum of PV(FCFF) = $457.95M
```

---

#### Step 5: Calculate Terminal Value

Assumes perpetual growth beyond forecast period:

**Gordon Growth Model:**
```
Terminal Value = FCFF_final × (1 + g_terminal) / (WACC - g_terminal)
```

**Constraints:**
- g_terminal < WACC (otherwise mathematically invalid)
- Typical range: 2%-4% (≈ long-term GDP growth)
- System auto-adjusts if g_terminal ≥ WACC

**Why Terminal Value Matters:**
- Represents 60%-80% of total enterprise value
- Most sensitive assumption in DCF model

**Example:**
```
FCFF_year5 = $158.90M
g_terminal = 4%
WACC = 9.5%

TV = $158.90M × (1.04) / (0.095 - 0.04)
   = $165.26M / 0.055
   = $3,004.73M

PV(TV) = $3,004.73M / 1.095^5
       = $1,909.68M
```

---

#### Step 6: Calculate Enterprise Value

```
Enterprise Value = Σ(PV of Projected FCFF) + PV(Terminal Value)
```

**Example:**
```
Sum of PV(FCFF_1 to FCFF_5) = $457.95M
PV(Terminal Value) = $1,909.68M

Enterprise Value = $457.95M + $1,909.68M
                 = $2,367.63M
```

---

#### Step 7: Calculate Equity Value

Adjust for capital structure:

```
Equity Value = Enterprise Value - Net Debt

Where:
Net Debt = Total Debt - Cash & Equivalents
```

**Why Subtract Net Debt?**
- Enterprise Value = value to all capital providers
- Equity Value = value to shareholders only
- Must subtract debt claims
- Cash belongs to equity holders (add back by subtracting net debt)

**Example:**
```
Enterprise Value = $2,367.63M
Total Debt = $500M
Cash & Equivalents = $200M
Net Debt = $500M - $200M = $300M

Equity Value = $2,367.63M - $300M
             = $2,067.63M
```

---

#### Step 8: Calculate Intrinsic Price Per Share

```
Intrinsic Price = Equity Value / Shares Outstanding
```

**Example:**
```
Equity Value = $2,067.63M
Shares Outstanding = 100M

Intrinsic Price = $2,067.63M / 100M
                = $20.68 per share

If Current Price = $25:
Upside = ($20.68 - $25) / $25 = -17.3% (overvalued)
```

---

### 2. Multiples Valuation (Relative Valuation)

Compares the target company to industry peers using standardized ratios.

#### Multiples Explained

| Multiple | Formula | What It Measures | Best For |
|----------|---------|------------------|----------|
| **P/E** | Price / EPS | How much investors pay per $1 of earnings | Profitable companies with stable earnings |
| **P/B** | Price / Book Value per Share | Price relative to net asset value | Asset-heavy industries (banks, real estate) |
| **P/S** | Price / Sales per Share | Revenue-based valuation | Unprofitable growth companies |
| **EV/EBITDA** | Enterprise Value / EBITDA | Operating performance multiple | Capital-intensive industries, cross-border comparisons |

---

#### Calculation Process

**Step 1: Fetch Peer Multiples**

For each peer company:
1. Fetch current multiples from Alpha Vantage or yfinance
2. Store: P/E, Forward P/E, P/B, P/S, EV/EBITDA

**Example Peer Data:**
```
Peer Multiples:
         P/E    P/B    P/S    EV/EBITDA
MSFT    35.2   12.5   11.2   22.3
GOOGL   27.8   6.8    6.4    18.5
META    28.4   6.2    7.1    15.2
NVDA    58.3   22.1   21.5   45.2
```

---

**Step 2: Calculate Median (Not Mean)**

```
Median P/E = 31.8  (between 28.4 and 35.2)
Median P/B = 9.65  (between 6.8 and 12.5)
Median P/S = 9.15  (between 7.1 and 11.2)
Median EV/EBITDA = 20.4  (between 18.5 and 22.3)
```

**Why Median?**
- Robust to outliers (e.g., NVDA's high multiples)
- Better represents "typical" peer valuation
- Mean would be skewed by extremes

---

**Step 3: Calculate Implied Prices**

**For P/E:**
```
Target EPS = Net Income / Shares Outstanding
Implied Price = Peer Median P/E × Target EPS
```

**Example:**
```
Target: Net Income = $100M, Shares = 100M
EPS = $100M / 100M = $1.00

Peer Median P/E = 31.8
Implied Price = 31.8 × $1.00 = $31.80
```

---

**For P/B:**
```
Book Value = Total Assets - Total Liabilities
Book Value per Share = Book Value / Shares Outstanding
Implied Price = Peer Median P/B × Book Value per Share
```

**Example:**
```
Book Value = $500M
Shares = 100M
Book Value per Share = $5.00

Peer Median P/B = 9.65
Implied Price = 9.65 × $5.00 = $48.25
```

---

**For P/S:**
```
Sales per Share = Total Revenue / Shares Outstanding
Implied Price = Peer Median P/S × Sales per Share
```

**Example:**
```
Revenue = $1,000M
Shares = 100M
Sales per Share = $10.00

Peer Median P/S = 9.15
Implied Price = 9.15 × $10.00 = $91.50
```

---

**For EV/EBITDA:**
```
EBITDA = EBIT + Depreciation & Amortization
Implied EV = Peer Median EV/EBITDA × Target EBITDA
Implied Equity Value = Implied EV - Net Debt
Implied Price = Implied Equity Value / Shares
```

**Example:**
```
EBIT = $150M
D&A = $25M
EBITDA = $175M

Peer Median EV/EBITDA = 20.4
Implied EV = 20.4 × $175M = $3,570M

Net Debt = $300M
Implied Equity Value = $3,570M - $300M = $3,270M

Shares = 100M
Implied Price = $3,270M / 100M = $32.70
```

---

**Step 4: Outlier Filtering**

Exclude implied prices deviating >50% from current price:

```python
Current Price = $30

Implied Prices:
P/E: $31.80 → Deviation = |31.80-30|/30 = 6% ✓ Include
P/B: $48.25 → Deviation = |48.25-30|/30 = 61% ✗ Exclude (outlier)
P/S: $91.50 → Deviation = |91.50-30|/30 = 205% ✗ Exclude (outlier)
EV/EBITDA: $32.70 → Deviation = |32.70-30|/30 = 9% ✓ Include
```

**Rationale:**
- Prevents distortion from incomparable peers
- P/B and P/S outliers suggest different business model

---

**Step 5: Average Implied Price**

```
Average Price = mean([valid implied prices])
              = mean([$31.80, $32.70])
              = $32.25
```

---

### 3. Blended Recommendation

Combines both methodologies for robust valuation.

**Blended Target Price:**
```
Blended Target = (DCF Price × 0.60) + (Multiples Price × 0.40)
```

**Example:**
```
DCF Price = $20.68
Multiples Price = $32.25

Blended = ($20.68 × 0.60) + ($32.25 × 0.40)
        = $12.41 + $12.90
        = $25.31
```

**Upside Calculation:**
```
Current Price = $25.00
Upside = ($25.31 - $25.00) / $25.00
       = 1.24%
```

**Decision Rules:**

| Upside % | Recommendation | Confidence | Rationale |
|----------|----------------|------------|-----------|
| > 30% | BUY | High | Significant undervaluation, high conviction |
| 20%-30% | BUY | Medium | Moderate undervaluation |
| -15% to 20% | HOLD | Medium | Fairly valued, wait for better entry |
| -25% to -15% | SELL | Medium | Moderate overvaluation |
| < -25% | SELL | High | Significant overvaluation, high conviction |

**Example:** Upside = 1.24% → **HOLD (Medium Confidence)**

---

##  Example Output

### Terminal Output
```
======================================================================
DCF VALUATION
======================================================================
Forecast Growth (CAGR):        8.92%
WACC:                          10.10%
DCF Intrinsic Price:           $145.23
Current Price:                 $255.53
DCF Upside:                    -43.16%

======================================================================
MULTIPLES VALUATION
======================================================================
Current Multiples (AAPL):
  P/E: 33.11
  P/B: 50.94
  P/S: 8.76
  EV/EBITDA: 26.25

Implied Prices by Multiple:
  P/E: $248.67
  P/B: $49.41
  P/S: $311.46
  EV/EBITDA: $205.12

Multiples Average Price:       $203.66

======================================================================
BLENDED RECOMMENDATION (60% DCF / 40% Multiples)
======================================================================
Blended Target Price:          $168.60
Current Price:                 $255.53
Blended Upside:                -34.03%

======================================================================
FINAL RECOMMENDATION: SELL (High Confidence)
======================================================================
```

### JSON Structure
```json
{
  "ticker": "AAPL",
  "report_date": "2024-01-15T14:30:00",
  "current_price": 255.53,
  "recommendation": "SELL",
  "confidence": "High",
  "blended_target": 168.60,
  "upside_potential": -34.03,
  "dcf_valuation": { ... },
  "multiples_valuation": { ... },
  "sensitivity": [ ... ],
  "ai_report": "..."
}
```

---

##  API Rate Limits

### Alpha Vantage (Free Tier)
- **5 calls per minute**
- **25 calls per day**
- **Solution:** 72-hour caching system

### Anthropic Claude
- Pay-per-use pricing
- ~$0.01-0.05 per report
- **Solution:** Cache API responses when possible

### Yahoo Finance (yfinance)
- Strict rate limiting
- **Solution:** 
  - Exponential backoff retry logic
  - 72-hour market data cache
  - Alpha Vantage primary, yfinance fallback

---

## Troubleshooting

### Data Collection Issues

#### "Too Many Requests" Error from Alpha Vantage

**Symptoms:**
```
Error: {"Note": "Thank you for using Alpha Vantage! Our standard API call frequency is 5 calls per minute..."}
```

**Cause:** Exceeded Alpha Vantage rate limits (5 calls/minute, 25 calls/day on free tier)

**Solutions:**
1. **Wait and retry:** API limits reset after 1 minute (for per-minute limit) or 24 hours (for daily limit)
2. **Use cached data:** The system automatically uses cached data if available
   ```bash
   # Check cache age
   cat data/cache/market_data_cache.csv

   # Cache is valid for 72 hours, so just wait if recently fetched
   ```
3. **Upgrade API tier:** Purchase Premium plan for higher limits (75-1200 calls/minute)
4. **Use multiple API keys:** Rotate between different Alpha Vantage keys
   ```python
   # In .env
   ALPHA_VANTAGE_API_KEY=key1
   ALPHA_VANTAGE_API_KEY_MOHAMED=key2
   ```

---

#### "FCFF Data Insufficient" Error

**Symptoms:**
```
ValueError: Not enough historical FCF data to compute CAGR
ValueError: Need at least 3 years of data, but only have 2
```

**Cause:** Insufficient historical financial data (company too new or data quality issues)

**Solutions:**
1. **Re-collect data:**
   ```bash
   rm -rf data/raw/TICKER
   python src/Data_collector.py TICKER
   ```

2. **Reduce CAGR years** in `fundamental_analyzer.py`:
   ```python
   # Original (requires 3+ years)
   cagr_years = 2  # Uses 3 years of data (year 0, 1, 2)

   # Modified (requires 2+ years)
   cagr_years = 1  # Uses 2 years of data
   ```

3. **Check data quality:**
   ```bash
   # Inspect the CSV files
   cat data/raw/TICKER/income_statement.csv
   cat data/raw/TICKER/cash_flow.csv
   ```

   Ensure columns have numeric values (not NaN or empty)

4. **Use alternative ticker:** Some companies may have incomplete data
   ```bash
   # Try different ticker symbol
   python src/ai_agent.py AAPL  # Instead of newer IPO
   ```

---

#### Missing or Invalid Financial Data

**Symptoms:**
```
KeyError: 'Total Revenue'
KeyError: 'Net Income'
```

**Cause:** Financial statement field names don't match expected format

**Solution:**

Check available field names in CSV:
```bash
head -1 data/raw/TICKER/income_statement.csv
```

Update field mapping in `Data_collector.py`:
```python
def get_field_mapping(statement_type):
    if statement_type == 'income':
        return {
            'totalRevenue': 'Total Revenue',
            'netIncome': 'Net Income',
            # Add custom mappings for your data source
            'your_custom_field': 'Total Revenue',
        }
```

---

### Market Data Issues

#### Risk-Free Rate Fetch Failure

**Symptoms:**
```
ERROR: Could not fetch 10-year Treasury rate from ANY source!
All Treasury rate sources failed. Cannot proceed without risk-free rate.
```

**Cause:** All data sources (FRED, Alpha Vantage, Treasury.gov, etc.) are temporarily unavailable

**Solutions:**
1. **Check internet connection:** Ensure you're not behind a firewall
2. **Wait and retry:** APIs may be temporarily down
3. **Manual override** (temporary workaround):
   ```python
   # In fundamental_analyzer.py
   def risk_free_rate(self):
       return 0.045  # Manually set to 4.5% (current as of Jan 2024)
   ```
4. **Use cached rate:** If you've run analysis recently, cache should have rate
5. **Check API keys:** Verify Alpha Vantage key is valid
   ```bash
   curl "https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=10year&apikey=YOUR_KEY"
   ```

---

#### Yahoo Finance / yfinance Errors

**Symptoms:**
```
Yahoo Finance error. Waiting 15 seconds before retry...
Yahoo Finance failed after 2 attempts
```

**Cause:** Yahoo Finance has aggressive rate limiting and blocks automated requests

**Solutions:**
1. **Use Alpha Vantage instead:** Set API key to use Alpha Vantage as primary source
2. **Exponential backoff:** System automatically retries with delays
3. **Use cached data:** Market data cache lasts 72 hours
4. **Add random delays:**
   ```python
   import time, random
   time.sleep(random.uniform(5, 15))  # Random delay between requests
   ```

---

### AI Model Issues

#### Anthropic Claude API Error

**Symptoms:**
```
Anthropic failed: Invalid API key
Anthropic failed: Insufficient credits
```

**Solutions:**
1. **Verify API key:**
   ```bash
   # Check .env file
   cat .env | grep ANTHROPIC

   # Test API key
   curl https://api.anthropic.com/v1/messages \
     -H "x-api-key: $ANTHROPIC_API_KEY" \
     -H "anthropic-version: 2023-06-01" \
     -H "content-type: application/json" \
     -d '{"model": "claude-sonnet-4-20250514", "max_tokens": 10, "messages": [{"role": "user", "content": "test"}]}'
   ```

2. **Check billing:**
   - Go to https://console.anthropic.com/settings/billing
   - Add payment method if needed
   - Verify sufficient credits

3. **Use GPT-4 fallback:** System automatically tries OpenAI if Claude fails
   - Ensure `OPENAI_API_KEY` is set in `.env`

---

#### OpenAI GPT-4 API Error

**Symptoms:**
```
OpenAI failed: Invalid API key
OpenAI failed: Insufficient quota
```

**Solutions:**
1. **Check API key:** Verify in `.env` file
2. **Check quota:**
   - Go to https://platform.openai.com/account/billing
   - Add credits if needed ($5-10 minimum)
3. **Verify GPT-4 access:**
   - GPT-4 requires payment tier
   - New accounts may only have GPT-3.5 access

---

### Calculation Errors

#### WACC Calculation Failure

**Symptoms:**
```
ValueError: Debt + equity is zero; cannot compute WACC
ZeroDivisionError in WACC calculation
```

**Cause:** Missing or invalid balance sheet data

**Solutions:**
1. **Check balance sheet data:**
   ```bash
   cat data/raw/TICKER/balance_sheet.csv
   ```

   Verify:
   - Total Assets > 0
   - Total Liabilities present
   - Data is numeric (not NaN)

2. **Inspect equity calculation:**
   ```python
   from fundamental_analyzer import FundamentalAnalyzer
   analyzer = FundamentalAnalyzer("TICKER")

   # Debug equity
   equity = analyzer._equity()
   print(equity)
   ```

3. **Manually verify ticker:** Ensure ticker symbol is correct
   ```bash
   # Wrong: APPL (missing A)
   # Correct: AAPL
   ```

---

#### Terminal Growth >= WACC Error

**Symptoms:**
```
Terminal Value calculation results in negative or infinite value
```

**Cause:** Terminal growth rate is too high relative to WACC

**Solution:**

System automatically adjusts, but you can force lower terminal growth:
```python
dcf_result = analyzer.dcf_valuation(
    terminal_growth=0.025,  # Lower terminal growth (2.5%)
    default_erp=0.07,       # Higher ERP to increase WACC
)
```

**Constraint:** terminal_growth must be < WACC - 0.005 (50 basis points buffer)

---

### PDF Generation Issues

#### ReportLab Import Error

**Symptoms:**
```
ModuleNotFoundError: No module named 'reportlab'
```

**Solution:**
```bash
pip install reportlab pillow --upgrade
```

---

#### PDF Formatting / Encoding Error

**Symptoms:**
```
UnicodeDecodeError in PDF generation
Error generating PDF: ...
```

**Cause:** Special characters in AI-generated text

**Solution:**

System has fallback logic, but if persists:
```python
# In report_generator.py, force clean text
ai_text = ai_text.encode('ascii', 'ignore').decode('ascii')
```

---

#### Permission Denied Writing PDF

**Symptoms:**
```
PermissionError: [Errno 13] Permission denied: 'reports/report_AAPL.pdf'
```

**Solution:**
```bash
# Create reports directory with correct permissions
mkdir -p reports
chmod 755 reports

# If file exists and is locked
rm reports/report_AAPL*.pdf

# Check disk space
df -h
```

---

### General Debugging

#### Enable Verbose Logging

Add debug output to troubleshoot:

```python
# In fundamental_analyzer.py
import logging
logging.basicConfig(level=logging.DEBUG)

# Or add print statements
print(f"DEBUG: FCFF series: {fcff_series}")
print(f"DEBUG: Market data cache: {self.market_data_cache}")
```

#### Inspect Intermediate Results

```python
from fundamental_analyzer import FundamentalAnalyzer

analyzer = FundamentalAnalyzer("AAPL", data_path="data/raw/AAPL")

# Check data loaded correctly
print("Income statement shape:", analyzer.income.shape)
print("Balance sheet shape:", analyzer.balance.shape)
print("Cash flow shape:", analyzer.cashflow.shape)

# Check FCFF calculation
fcf = analyzer.free_cash_flow_fcff()
print("FCFF:\n", fcf)

# Check WACC components
print(f"Cost of Equity: {analyzer.cost_of_equity_capm():.2%}")
print(f"Cost of Debt: {analyzer.cost_of_debt():.2%}")
print(f"WACC: {analyzer.wacc():.2%}")
```

#### Check Python Environment

```bash
# Verify Python version (3.8+ required)
python --version

# Check installed packages
pip list | grep -E "pandas|numpy|yfinance|anthropic|openai|reportlab"

# Reinstall if needed
pip install -r requirements.txt --force-reinstall
```

---

##  Limitations & Assumptions

### Data Quality
- Relies on Alpha Vantage and yfinance data accuracy
- Historical data may have gaps or errors
- Real-time prices have 15-minute delay on free tier

### Valuation Assumptions
- CAPM holds and beta is stable
- Terminal growth < GDP growth
- Market efficiency in peer comparisons
- Historical CAGR predicts future growth

### Model Limitations
- No consideration of qualitative factors
- Binary recommendation system (no partial positions)
- Assumes rational market behavior
- No scenario analysis beyond terminal growth sensitivity

---

##  Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit changes (`git commit -m 'Add AmazingFeature'`)
4. Push to branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

---

##  License

This project is licensed under the MIT License - see the LICENSE file for details.

---

##  Disclaimer

**This tool is for educational and informational purposes only.**

- NOT financial advice
- NOT a recommendation to buy, sell, or hold securities
- Past performance does not guarantee future results
- All investments involve risk, including loss of principal
- Consult a qualified financial advisor before making investment decisions

The authors and contributors are not responsible for any financial losses incurred from using this tool.

---

##  Acknowledgments

- **Alpha Vantage** - Financial data API
- **Anthropic Claude** - AI analysis engine
- **yfinance** - Market data fallback
- **ReportLab** - PDF generation

---
